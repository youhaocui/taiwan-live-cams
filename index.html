<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>台灣即時直播四分割監看</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{
      height:100%; margin:0; padding:0; background:#000;
      font-family: system-ui, sans-serif; color:#fff; overflow:hidden;
    }

    /* 底部控制列 */
    .controls{
      position:fixed; bottom:0; left:0; width:100%; height:70px;
      background:rgba(12,12,12,0.95); color:#fff; padding:6px 12px;
      box-sizing:border-box; display:flex; flex-direction:row; align-items:center;
      gap:10px; z-index:3000; overflow:hidden;
    }

    /* 縣市 / 景點 容器（可左右滾動） */
    #regionButtons{
      display:flex; flex-grow:1; min-width:0; gap:6px;
      overflow-x:auto; padding-bottom:6px; height:100%; align-items:center;
    }
    #regionButtons::-webkit-scrollbar{ height:6px; background-color:rgba(255,255,255,0.06); }
    #regionButtons::-webkit-scrollbar-thumb{ background-color:#444; border-radius:3px; }

    .row{ display:flex; flex-wrap:nowrap; gap:6px; align-items:center; }
    .divider{ width:1px; height:60%; background:#333; flex-shrink:0; margin:0; }
    .fixed-cams{ flex-shrink:0; display:flex; gap:6px; }

    .controls button{
      background-color:#222; color:#fff; border:1px solid #444;
      padding:6px 10px; font-size:13px; cursor:pointer; border-radius:6px;
      height:40px; flex-shrink:0; white-space:nowrap; text-align:center;
    }
    .controls button.active{ background-color:#0078d7; border-color:#0078d7; box-shadow:0 1px 0 rgba(0,0,0,0.3); }
    .controls button.back-button{ background-color:#444; border-color:#555; }

    /* 區域純文字標示（白色） */
    #regionButtons .region-label {
      color:#fff;
      margin:0 8px 0 4px;
      font-weight:600;
      flex-shrink:0;
      user-select:none;
    }

    /* 統一框框樣式（縣市與景點按鈕一致） */
    #regionButtons .city-btn{
      background-color:#111; color:#fff; border:1px solid #555;
      padding:6px 10px; margin:0 4px; border-radius:6px; cursor:pointer;
      height:36px; flex-shrink:0; font-size:13px;
    }
    #regionButtons .city-btn:hover{ background-color:#1a1a1a; border-color:#666; }

    .stage-wrap{
      position:fixed; top:0; left:0; width:100vw; height:calc(100vh - 70px);
      display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr;
      gap:0; z-index:1;
    }
    .cell{ position:relative; width:100%; height:100%; overflow:hidden; background:#000; }

    .player-container, .player-container iframe{
      position:absolute; inset:0; width:100%; height:100%; border:0; display:block;
      object-fit:cover; object-position:center; background:black;
      transform: scale(1.65) translateY(-6%);
    }

    .interaction-shield{ position:absolute; inset:0; z-index:5; background:transparent; cursor:default; }

    .label{
      position:absolute; left:8px; right:8px; bottom:8px; display:flex;
      flex-direction:column; align-items:flex-start; padding:6px 8px;
      font-size:14px; color:#fff; background:rgba(0,0,0,0.6); border-radius:6px;
      pointer-events:none; z-index:10;
    }
    .source-on-screen{ font-size:11px; color:#ccc; margin-top:4px; line-height:1.1; }

    /* 隱藏所有標籤（設定） */
    .hide-labels .label{ display:none; }

    /* 全螢幕模式 */
    .fullscreen-active .controls{ display:none; }
    .fullscreen-active .stage-wrap{ height:100vh; }

    /* 設定介面：固定於畫面上層（不被 iframe 蓋過） */
    .settings-menu{ position:relative; }
    .settings-panel{
      position:fixed; bottom:86px; right:20px;
      background:rgba(20,20,20,0.98); border:1px solid #444; border-radius:8px;
      display:flex; flex-direction:column; gap:8px; padding:10px; min-width:180px;
      z-index:99999; /* 保證在最上層 */
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    .settings-panel.hidden{ display:none; }
    .settings-panel button{
      background:#111; color:#fff; border:1px solid #333;
      padding:8px 10px; font-size:13px; cursor:pointer; border-radius:6px; text-align:left;
    }

    @media (max-width:640px){
      .controls{ padding:6px 8px; height:72px; }
      .controls button{ padding:6px 8px; font-size:12px; height:36px; }
      #regionButtons .city-btn{ padding:6px 8px; font-size:12px; height:34px; }
      .settings-panel{ right:10px; bottom:90px; min-width:160px; }
    }
  </style>
</head>
<body>
  <div class="controls" id="controls">
    <div class="row fixed-cams">
      <button id="select-cam-0" class="active" onclick="selectCam(0)">左上</button>
      <button id="select-cam-1" onclick="selectCam(1)">右上</button>
      <button id="select-cam-2" onclick="selectCam(2)">左下</button>
      <button id="select-cam-3" onclick="selectCam(3)">右下</button>
    </div>

    <div class="divider"></div>

    <div id="regionButtons" aria-label="縣市與景點選單" role="toolbar"></div>

    <div class="divider"></div>
    <button id="fullscreenBtn" onclick="toggleFullscreen()">全螢幕</button>

    <div class="divider"></div>

    <!-- 設定按鈕與面板（移除母子畫面，只保留標籤切換） -->
    <div class="settings-menu">
      <button id="settingsBtn" onclick="toggleSettingsMenu()">設定 ⚙️</button>
      <div id="settingsPanel" class="settings-panel hidden" role="dialog" aria-hidden="true">
        <button id="labelsToggleBtn" onclick="toggleLabels()">標籤隱藏</button>
      </div>
    </div>

    <div class="divider"></div>
    <button id="muteBtn" onclick="toggleMute()">取消靜音</button>
  </div>

  <div class="stage-wrap" id="stageWrap">
    <div class="cell" data-index="0">
      <div id="player0" class="player-container"></div>
      <div class="interaction-shield"></div>
      <div class="label" id="label0">載入中...<span class="source-on-screen"></span></div>
    </div>
    <div class="cell" data-index="1">
      <div id="player1" class="player-container"></div>
      <div class="interaction-shield"></div>
      <div class="label" id="label1">載入中...<span class="source-on-screen"></span></div>
    </div>
    <div class="cell" data-index="2">
      <div id="player2" class="player-container"></div>
      <div class="interaction-shield"></div>
      <div class="label" id="label2">載入中...<span class="source-on-screen"></span></div>
    </div>
    <div class="cell" data-index="3">
      <div id="player3" class="player-container"></div>
      <div class="interaction-shield"></div>
      <div class="label" id="label3">載入中...<span class="source-on-screen"></span></div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // 只保留你提供的直播來源（不要多餘）
    const ALL_STREAMS = {
      "台北-象山看101": {"id": "z_fY1pj1VBw", "label": "台北象山", "source": "Taipei Travel Live Cam 台北觀光即時影像"},
      "台北-大稻埕": {"id": "Ndo_8RuefH4", "label": "大稻埕", "source": "Taipei Travel Live Cam 台北觀光即時影像"},
      "台北-碧山巖": {"id": "uvwfYzwY8tg", "label": "碧山巖", "source": "Taipei Travel Live Cam 台北觀光即時影像"},
      "台北-微風平台": {"id": "34h_Cy_n0Ok", "label": "微風平台", "source": "Taipei Travel Live Cam 台北觀光即時影像"},
      "台北-貓空指南宮": {"id": "215ahZ_0rTg", "label": "貓空指南宮", "source": "Taipei Travel Live Cam 台北觀光即時影像"},
      "新北-漁人碼頭": {"id": "xwAWSh35uuw", "label": "新北淡水", "source": "新北旅客 New Taipei Tour"},
      "新北-鼻頭服務區": {"id": "4Bm3IKcGkQY", "label": "新北鼻頭", "source": "necoast nsa"},
      "基隆-外木山": {"id": "LInNQYAbAwQ", "label": "外木山", "source": "GoOcean海洋遊憩風險資訊"},
      "桃園-國際機場": {"id": "91PfFoqvuUk", "label": "桃園機場", "source": "遊桃園 Taoyuan Travel"},
      "桃園-桃園機場南跑道": {"id": "y3_x8el5ZJY", "label": "TPE 南跑道", "source": "Taoyuan Airport"},
      "桃園-桃園機場北跑道": {"id": "wWEnxWA7nnY", "label": "TPE 北跑道", "source": "Taoyuan Airport"},
      "桃園-永安漁港": {"id": "tD_a03trUvE", "label": "永安漁港", "source": "遊桃園 Taoyuan Travel"},
      "桃園-拉拉山遊客中心": {"id": "YkIUZjVlhv4", "label": "拉拉山遊客中心", "source": "遊桃園 Taoyuan Travel"},
      "桃園-虎頭山環保公園": {"id": "tu_gsIkNt-w", "label": "虎頭山環保公園", "source": "遊桃園 Taoyuan Travel"},
      "桃園-小烏來天空步道": {"id": "neaiCec1kec", "label": "小烏來天空步道", "source": "遊桃園 Taoyuan Travel"},
      "桃園-角板山思親亭": {"id": "3Za9y4z_Lzc", "label": "角板山思親亭", "source": "遊桃園 Taoyuan Travel"},
      "桃園-三龜戲水觀景平台": {"id": "5YDXZ1aiR5Y", "label": "三龜戲水觀景平台", "source": "遊桃園 Taoyuan Travel"},
      "桃園-大溪橋": {"id": "oFJ6gCaBb_Q", "label": "大溪橋", "source": "遊桃園 Taoyuan Travel"},
      "桃園-虎頭山奧爾森林學堂": {"id": "yQSmajHyMhU", "label": "虎頭山奧爾森林學堂", "source": "遊桃園 Taoyuan Travel"},
      "桃園-角板山梅園": {"id": "-xT1bZhWLuU", "label": "角板山梅園", "source": "遊桃園 Taoyuan Travel"},
      "桃園-角板山生態池": {"id": "XEbo8NzMTbQ", "label": "角板山生態池", "source": "遊桃園 Taoyuan Travel"},
      "桃園-大溪老街": {"id": "XUWjAsajKXg", "label": "大溪老街", "source": "遊桃園 Taoyuan Travel"},
      "桃園-石門水庫": {"id": "GUCaVR88ZFU", "label": "石門水庫", "source": "遊桃園 Taoyuan Travel"},
      "桃園-慈湖水岸廣場": {"id": "pSQ0e-ZTZ5g", "label": "慈湖水岸廣場", "source": "遊桃園 Taoyuan Travel"},
      "桃園-阿姆坪薑母島": {"id": "EUOp2LchPQM", "label": "阿姆坪薑母島", "source": "遊桃園 Taoyuan Travel"},
      "桃園-上巴陵": {"id": "nV-DKquUjFs", "label": "上巴陵", "source": "遊桃園 Taoyuan Travel"},
      "桃園-桃園國際機場凱悅酒店": {"id": "68GFgzQxrXs", "label": "機場凱悅", "source": "遊桃園 Taoyuan Travel"},
      "桃園-小烏來寰宇平台": {"id": "PJWye36lEj4", "label": "寰宇平台", "source": "遊桃園 Taoyuan Travel"},
      "桃園-許厝港濕地": {"id": "44JArbF682k", "label": "許厝港濕地", "source": "遊桃園 Taoyuan Travel"},
      "宜蘭-外澳沙灘": {"id": "UgoT-QTbYvo", "label": "宜蘭外澳", "source": "necoast nsa"},
      "宜蘭-福隆海水浴場": {"id": "AxG-Jssz8fg", "label": "宜蘭福隆", "source": "necoast nsa"},
      "宜蘭-舊隧道南口": {"id": "f38lFhncLVA", "label": "宜蘭石城", "source": "necoast nsa"},
      "宜蘭-無尾港": {"id": "gPeJuFuNcRc", "label": "無尾港", "source": "GoOcean海洋遊憩風險資訊"},
      "宜蘭-石城漁港": {"id": "ozZVLl0h--A", "label": "石城漁港", "source": "GoOcean海洋遊憩風險資訊"},
      "台東-鯉魚山": {"id": "BUJJaW0vkJs", "label": "台東鯉魚山", "source": "Amazing Taitung 台東就醬玩"},
      "台東-金崙大橋": {"id": "9QqBz3kNHis", "label": "台東金崙大橋", "source": "Amazing Taitung 台東就醬玩"},
      "台東-金樽觀浪": {"id": "q3KJt-SZc2s", "label": "台東金樽觀浪", "source": "Amazing Taitung 台東就醬玩"},
      "台東-富山": {"id": "Rsq95SQ26bY", "label": "台東富山", "source": "Amazing Taitung 台東就醬玩"},
      "台東-杉原灣": {"id": "VqS_Y8ZCj6M", "label": "台東杉原灣", "source": "Amazing Taitung 台東就醬玩"},
      "台東-富岡漁港": {"id": "D945F_dauls", "label": "台東富岡漁港", "source": "Amazing Taitung 台東就醬玩"},
      "台東-華源曙光觀景台": {"id": "TY4qQElcUrA", "label": "台東華源曙光觀景台", "source": "Amazing Taitung 台東就醬玩"},
      "台東-南橫埡口": {"id": "LSkq-wHMxQY", "label": "台東南橫埡口", "source": "Amazing Taitung 台東就醬玩"},
      "台東-池上天堂路": {"id": "6kUEK3LVrro", "label": "台東池上天堂路", "source": "Amazing Taitung 台東就醬玩"},
      "台東-多良車站": {"id": "UCG1aXVO8H8", "label": "台東多良", "source": "Amazing Taitung 台東就醬玩"},
      "台東-鹿野高台": {"id": "rvc1klNIgQc", "label": "鹿野高台", "source": "ervnsa"},
      "花蓮-石梯坪": {"id": "mXnigLvIL0Q", "label": "花蓮石梯坪", "source": "東部海岸國家風景區管理處"},
      "台東-成功三仙台": {"id": "dQ7Sd6PGLdA", "label": "三仙台", "source": "東部海岸國家風景區管理處"},
      "台東-金樽遊憩區": {"id": "ZdqHgQwvZOw", "label": "金樽遊憩區", "source": "東部海岸國家風景區管理處"},
      "台東-綠島南寮": {"id": "wTHhv7M0vCI", "label": "綠島南寮", "source": "東部海岸國家風景區管理處"},
      "台東-都歷遊客中心": {"id": "JhQuR77AR7U", "label": "都歷遊客中心", "source": "東部海岸國家風景區管理處"},
      "台東-加路蘭遊憩區": {"id": "AKl3F6cAY2Q", "label": "加路蘭遊憩區", "source": "東部海岸國家風景區管理處"},
      "花蓮-大石鼻山": {"id": "JkoXcXI04Qk", "label": "大石鼻山", "source": "東部海岸國家風景區管理處"},
      "花蓮-長虹橋": {"id": "JnD8Rk3o0BM", "label": "長虹橋", "source": "東部海岸國家風景區管理處"},
      "台東-綠島帆船鼻": {"id": "pLdBc8PvZko", "label": "綠島帆船鼻", "source": "東部海岸國家風景區管理處"},
      "台東-綠島柴口浮潛區": {"id": "a8nJQr5rBGs", "label": "綠島柴口浮潛區", "source": "東部海岸國家風景區管理處"},
      "台中-高美濕地": {"id": "fjhg3gAnMFg", "label": "台中高美", "source": "大玩台中-臺中觀光旅遊局"},
      "台中-望高寮": {"id": "lhXXhDyjFtI", "label": "望高寮", "source": "大玩台中-臺中觀光旅遊局"},
      "嘉義-奮起湖": {"id": "B6eki-0-w0g", "label": "嘉義奮起湖", "source": "阿里山國家風景區管理處"},
      "嘉義-二延平步道": {"id": "j2L_559nCjc", "label": "二延平步道", "source": "阿里山國家風景區管理處"},
      "嘉義-太平雲梯": {"id": "dY2cRNr5Buw", "label": "太平雲梯", "source": "阿里山國家風景區管理處"},
      "嘉義-觸口遊客中心": {"id": "8KnqJBf_dow", "label": "觸口遊客中心", "source": "阿里山國家風景區管理處"},
      "嘉義-愛情大草原": {"id": "hMYs60qtkK8", "label": "愛情大草原", "source": "阿里山國家風景區管理處"},
      "嘉義-生力農場": {"id": "agEzlv9n9Eg", "label": "生力農場", "source": "阿里山國家風景區管理處"},
      "嘉義-里佳資訊站": {"id": "zDt8FBPozZQ", "label": "里佳資訊站", "source": "阿里山國家風景區管理處"},
      "彰化-王功漁港": {"id": "hUG2XK08W5Q", "label": "彰化王功", "source": "愛玩彰化 Changhua Travels"},
      "高雄-旗津海水浴場": {"id": "ka7FV0sCvxQ", "label": "高雄旗津", "source": "高雄旅遊網"},
      "屏東-墾丁南灣": {"id": "jUnFuJSj0OU", "label": "墾丁南灣", "source": "我愛墾丁旅遊票券中心"},
      "台南-七股賞鳥台": {"id": "5KJe2gCTngA", "label": "台南七股", "source": "內政部國家公園署台江國家公園管理處"},
      "台南-北汕尾水鳥保護區": {"id": "FES0gWTFUHQ", "label": "北汕尾水鳥保護區", "source": "內政部國家公園署台江國家公園管理處"},
      "台南-曾文水庫": {"id": "EH4V8IwFIp4", "label": "曾文水庫", "source": "西拉雅國家風景區管理處 Siraya National Scenic Area Administration"},
      "台南-火山碧雲寺": {"id": "zkX6X9p-6iA", "label": "火山碧雲寺", "source": "西拉雅國家風景區管理處 Siraya National Scenic Area Administration"},
      "高雄-壽山觀景台": {"id": "C03Itx8iSC0", "label": "壽山觀景", "source": "高雄旅遊網"},
      "金門-麒麟山森林公園": {"id": "M4EJtf_iP8s", "label": "金門麒麟山公園", "source": "樂遊金門"},
      "金門-134高地": {"id": "-srNHTE-Nf0", "label": "金門134高地", "source": "樂遊金門"},
      "金門-建功嶼": {"id": "uh_yNAE01w8", "label": "金門建功嶼", "source": "樂遊金門"}
    };

    // 區域與縣市（顯示分類文字＋縣市框）
    const REGION_GROUPS = {
      "北部": ["台北","新北","基隆","桃園","宜蘭"],
      "中部": ["台中","南投","彰化","苗栗","雲林","嘉義"],
      "南部": ["台南","高雄","屏東"],
      "東部": ["花蓮","台東"],
      "外島": ["金門","澎湖","馬祖"]
    };

    // 初始四格（如有不存在的 key 會自動回退）
    let INITIAL_CAMS_KEYS = [
      "台北-象山看101", "桃園-國際機場", "新北-漁人碼頭", "台東-多良車站"
    ];

    // 依縣市分組（只用你提供的來源）
    const GROUPED_STREAMS = {};
    for (const key in ALL_STREAMS){
      const city = key.split('-')[0] || '其他';
      if (!GROUPED_STREAMS[city]) GROUPED_STREAMS[city] = [];
      GROUPED_STREAMS[city].push({
        key, id: ALL_STREAMS[key].id, label: ALL_STREAMS[key].label, source: ALL_STREAMS[key].source
      });
    }
    // 保證每個縣市至少有空陣列（即使沒有直播）
    for (const region in REGION_GROUPS){
      REGION_GROUPS[region].forEach(city=>{
        if (!GROUPED_STREAMS[city]) GROUPED_STREAMS[city] = [];
      });
    }

    let currentCamKeys = [...INITIAL_CAMS_KEYS];
    let players = [];
    let isApiReady = false;
    const streamIds = {};
    for (const key in ALL_STREAMS) streamIds[key] = ALL_STREAMS[key].id;

    const camSelectButtons = [
      document.getElementById('select-cam-0'),
      document.getElementById('select-cam-1'),
      document.getElementById('select-cam-2'),
      document.getElementById('select-cam-3')
    ];
    const labels = [
      document.getElementById('label0'),
      document.getElementById('label1'),
      document.getElementById('label2'),
      document.getElementById('label3')
    ];
    let currentIndex = 0;

    document.addEventListener('DOMContentLoaded', ()=> renderRegionButtons());

    // 顯示格式：北部： [台北][新北] ... 中部： [台中][南投]...
    function renderRegionButtons(){
      const buttonContainer = document.getElementById('regionButtons');
      buttonContainer.innerHTML = '';

      for (const region in REGION_GROUPS){
        const regionLabel = document.createElement('span');
        regionLabel.className = 'region-label';
        regionLabel.textContent = region + '：';
        buttonContainer.appendChild(regionLabel);

        REGION_GROUPS[region].forEach(city=>{
          const btn = document.createElement('button');
          btn.className = 'city-btn';
          btn.innerText = city;
          btn.setAttribute('onclick', `renderLocationButtons('${city}')`);
          buttonContainer.appendChild(btn);
        });
      }
      buttonContainer.scrollLeft = 0;
    }

    function renderLocationButtons(city){
      const buttonContainer = document.getElementById('regionButtons');
      buttonContainer.innerHTML = '';
      const backButton = document.createElement('button');
      backButton.innerText = '← 返回';
      backButton.className = 'back-button';
      backButton.setAttribute('onclick', `renderRegionButtons()`);
      buttonContainer.appendChild(backButton);

      // 若該縣市無景點則顯示提示
      if (!GROUPED_STREAMS[city] || GROUPED_STREAMS[city].length === 0){
        const emptyLabel = document.createElement('span');
        emptyLabel.innerText = "（目前沒有景點）";
        emptyLabel.style.color = "#bbb";
        emptyLabel.style.marginLeft = "10px";
        buttonContainer.appendChild(emptyLabel);
      } else {
        GROUPED_STREAMS[city].forEach(stream=>{
          const button = document.createElement('button');
          button.className = 'city-btn';
          button.innerText = stream.label; // 顯示純景點名稱
          button.setAttribute('onclick', `setStream('${stream.key}')`);
          buttonContainer.appendChild(button);
        });
      }
      buttonContainer.scrollLeft = 0;
    }

    // YouTube API callback
    function onYouTubeIframeAPIReady(){
      isApiReady = true;
      for (let i=0;i<4;i++){
        const streamKey = INITIAL_CAMS_KEYS[i] || Object.keys(ALL_STREAMS)[i];
        const validKey = ALL_STREAMS[streamKey] ? streamKey : (Object.keys(ALL_STREAMS)[i] || Object.keys(ALL_STREAMS)[0]);
        createPlayer(i, validKey);
      }
      updateMuteButtonLabel();
    }

    function createPlayer(index, streamKey){
      const videoId = streamIds[streamKey];
      if (!videoId) return;
      if (players[index] && players[index].destroy) players[index].destroy();
      currentCamKeys[index] = streamKey;

      players[index] = new YT.Player('player'+index, {
        videoId,
        playerVars: {
          autoplay: 1, mute: 1, controls: 0, rel: 0, modestbranding: 1, fs: 0, iv_load_policy: 3
        },
        events: {
          onReady: onPlayerReady,
          onError: onPlayerError,
          onStateChange: onPlayerStateChange
        }
      });

      const lbl = ALL_STREAMS[streamKey].label || streamKey;
      const src = ALL_STREAMS[streamKey].source || '';
      labels[index].innerHTML = `${lbl}<span class="source-on-screen">來源: ${src}</span>`;
    }

    function getNextStreamKey(failingKey){
      const streamKeys = Object.keys(ALL_STREAMS);
      const failingIndex = streamKeys.indexOf(failingKey);
      for (let i=1;i<=streamKeys.length;i++){
        const nextIndex = (failingIndex + i) % streamKeys.length;
        const nextKey = streamKeys[nextIndex];
        if (nextKey !== failingKey) return nextKey;
      }
      return null;
    }

    function onPlayerError(event){
      const player = event.target;
      const index = players.findIndex(p => p === player);
      const failingKey = currentCamKeys[index];
      const code = event.data;
      labels[index].innerHTML = `${ALL_STREAMS[failingKey]?.label || failingKey} [錯誤 ${code}]<span class="source-on-screen">嘗試自動切換中...</span>`;
      if ([5,100,101,150].includes(code)){
        const newKey = getNextStreamKey(failingKey);
        if (newKey) createPlayer(index, newKey);
      }
    }

    function onPlayerReady(event){
      try { event.target.playVideo(); } catch(e){}
    }

    function refreshPlayer(player){
      if (!player) return;
      try {
        const videoData = player.getVideoData();
        const id = videoData.video_id;
        if (id) player.loadVideoById({ videoId: id, startSeconds: 0 });
      } catch(e){}
    }

    function onPlayerStateChange(event){
      const player = event.target;
      const state = event.data;
      if (state === YT.PlayerState.ENDED) refreshPlayer(player);
      if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.BUFFERING){
        try { player.playVideo(); } catch(e){}
      }
    }

    function selectCam(index){
      currentIndex = index;
      camSelectButtons.forEach(btn=>btn.classList.remove('active'));
      camSelectButtons[index].classList.add('active');
      updateMuteButtonLabel();
    }

    function setStream(streamKey){
      const videoId = streamIds[streamKey];
      if (!videoId) return alert("來源不存在：" + streamKey);
      if (!isApiReady || !players[currentIndex]) return;
      players[currentIndex].loadVideoById({ videoId, startSeconds:0 });
      currentCamKeys[currentIndex] = streamKey;
      const lbl = ALL_STREAMS[streamKey].label || streamKey;
      const src = ALL_STREAMS[streamKey].source || '';
      labels[currentIndex].innerHTML = `${lbl}<span class="source-on-screen">來源: ${src}</span>`;
    }

    // 設定面板顯示切換
    function toggleSettingsMenu(){
      const panel = document.getElementById('settingsPanel');
      const hidden = panel.classList.toggle('hidden');
      panel.setAttribute('aria-hidden', hidden ? 'true' : 'false');
    }

    // 標籤隱藏切換
    function toggleLabels(){
      document.body.classList.toggle('hide-labels');
      const btn = document.getElementById('labelsToggleBtn');
      btn.innerText = document.body.classList.contains('hide-labels') ? "標籤顯示" : "標籤隱藏";
    }

    // 全螢幕
    function toggleFullscreen(){
      const btn = document.getElementById('fullscreenBtn');
      if (!document.fullscreenElement){
        document.documentElement.requestFullscreen().then(()=>{
          document.body.classList.add('fullscreen-active');
          btn.innerText = "退出全螢幕";
        }).catch(err=>{
          alert("無法進入全螢幕: " + err.message);
        });
      } else {
        document.exitFullscreen();
      }
    }
    document.addEventListener('fullscreenchange', ()=>{
      const btn = document.getElementById('fullscreenBtn');
      if (!document.fullscreenElement){
        document.body.classList.remove('fullscreen-active');
        btn.innerText = "全螢幕";
      }
    });

    // 靜音切換（針對目前選中格）
    function toggleMute(){
      if (!isApiReady || !players[currentIndex]) return;
      const player = players[currentIndex];
      const btn = document.getElementById('muteBtn');
      try {
        if (player.isMuted()){
          player.unMute();
          btn.innerText = "靜音";
        } else {
          player.mute();
          btn.innerText = "取消靜音";
        }
      } catch(e){}
    }
    function updateMuteButtonLabel(){
      const btn = document.getElementById('muteBtn');
      const player = players[currentIndex];
      if (!isApiReady || !player){ btn.innerText = "取消靜音"; return; }
      try { btn.innerText = player.isMuted() ? "取消靜音" : "靜音"; } catch(e){ btn.innerText = "取消靜音"; }
    }

    // 預設選擇第一格
    selectCam(0);
  </script>
</body>
</html>
