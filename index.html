<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>台灣即時直播四分割監看 (純 YouTube 穩定版)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* =========================================
     * 基礎 CSS 樣式
     * ======================================== */
    html,body{
      height:100%; margin:0; padding:0; background:#000;
      font-family: system-ui, sans-serif; color:#fff; overflow:hidden;
    }
    .controls{
      position:fixed; bottom:0; left:0; width:100%; height:70px; 
      background:rgba(12,12,12,0.9); color:#fff; padding:5px 10px; 
      box-sizing:border-box; 
      display:flex; flex-direction:row; align-items: center; 
      gap:10px; 
      z-index:999;
      overflow-x: auto; /* 允許橫向滾動 */
      overflow-y: hidden;
    }

    /* 滾動條樣式 */
    .controls::-webkit-scrollbar{ height: 4px; background-color: rgba(255, 255, 255, 0.1); }
    .controls::-webkit-scrollbar-thumb { background-color: #555; border-radius: 2px; }

    .control-item{
      min-width: 120px; /* 確保按鈕不會被過度壓縮 */
      padding: 8px 12px;
      background-color: #333;
      border: 1px solid #555;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s;
      white-space: nowrap;
    }
    .control-item:hover{
      background-color: #555;
    }
    .control-item.selected{
      background-color: #007bff; /* 藍色背景表示已選中 */
      border-color: #007bff;
    }

    /* =========================================
     * 影片容器樣式 (四分割佈局)
     * ======================================== */
    .video-grid {
      display: grid;
      /* 2x2 網格佈局 */
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      width: 100vw;
      height: calc(100vh - 70px); /* 扣除底部控制列的高度 */
    }

    .video-container {
      position: relative;
      /* 確保 iframe 填滿整個格子 */
      width: 100%;
      height: 100%;
      overflow: hidden;
      border: 1px solid #111; /* 分隔線 */
      box-sizing: border-box;
      cursor: pointer;
    }

    .video-container.selected {
      /* 選中時的外框，用於視覺提示 */
      border: 5px solid #007bff; 
    }

    /* YouTube iframe 樣式 */
    .youtube-player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* 影片資訊標籤 */
    .video-label {
      position: absolute;
      top: 5px;
      left: 5px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 14px;
      z-index: 10;
    }
    
    /* 延遲資訊顯示 */
    #latency-display {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 14px;
      z-index: 10;
    }

    /* 隱藏未使用的 iframe 容器 */
    .hidden-player {
      display: none;
    }
  </style>
</head>
<body>

<div class="video-grid" id="video-grid">
    </div>

<div class="controls" id="controls">
    <div id="latency-display">延遲：即時/誤差</div> 
    
    </div>

<script>
    // ========================================
    // 配置設定
    // ========================================

    // 所有的直播連結列表 (請在這裡新增您想監看的直播)
    // 格式： "自定義標籤": {"id": "YouTube-Video-ID", "label": "顯示名稱", "source": "來源頻道名稱"}
    const ALL_STREAMS = {
        "台北-象山看101": {"id": "z_fY1pj1VBw", "label": "台北象山", "source": "Taipei Travel Live Cam 台北觀光即時影像"},
        "桃園-國際機場": {"id": "sR-d1qC18-Q", "label": "桃園機場 (北跑道)", "source": "Taoyuan Airport"}, // <--- 已更新為北跑道清晰版
        "新北-漁人碼頭": {"id": "WzX83Xj3nS4", "label": "新北漁人碼頭", "source": "New Taipei City"},
        "台東-多良車站": {"id": "d0m7U1q0M1o", "label": "台東多良車站", "source": "TTN 台東新聞"},
        
        // --- 更多備用/可切換的直播來源 ---
        "台中-高美濕地": {"id": "f516d00e93", "label": "台中高美", "source": "Taichung Tourism"},
        "高雄-壽山情人觀景台": {"id": "xY8990a426", "label": "高雄壽山", "source": "Kaohsiung Tourism"},
        "花蓮-七星潭": {"id": "P3d3aC9m_A0", "label": "花蓮七星潭", "source": "Hualien County Government"},
        "中央氣象署-CWA": {"id": "5U0Q932e60", "label": "中央氣象署", "source": "CWA"},
        // 更多直播可以繼續添加...
    };

    // 初始載入四分割畫面時的預設配置 (請用這裡的順序來控制畫面位置)
    // 順序：[左上, 右上, 左下, 右下]
    let INITIAL_CAMS_KEYS = [
        "台北-象山看101", 
        "新北-漁人碼頭",   // 調整到右上角
        "桃園-國際機場",  // 調整到左下角
        "台東-多良車站"
    ];

    // ========================================
    // 程式邏輯
    // ========================================
    const NUM_CAMS = 4; // 固定四分割
    const videoGrid = document.getElementById('video-grid');
    const controls = document.getElementById('controls');
    const latencyDisplay = document.getElementById('latency-display');
    const players = [];
    let currentKeys = [...INITIAL_CAMS_KEYS]; // 當前正在播放的四個 key
    let currentIndex = 0; // 當前選中的畫面索引 (0-3)
    let isApiReady = false;

    /**
     * 初始化：在網頁載入時建立四個 YouTube 播放器 iframe 容器
     */
    function createInitialContainers() {
        for (let i = 0; i < NUM_CAMS; i++) {
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = `container-${i}`;
            container.dataset.index = i;
            container.addEventListener('click', () => selectCam(i));

            const playerDiv = document.createElement('div');
            playerDiv.id = `player-${i}`;
            playerDiv.className = 'youtube-player';

            const labelDiv = document.createElement('div');
            labelDiv.className = 'video-label';
            labelDiv.id = `label-${i}`;

            container.appendChild(playerDiv);
            container.appendChild(labelDiv);
            videoGrid.appendChild(container);
        }
    }
    
    /**
     * 初始化：根據 ALL_STREAMS 建立所有可切換的控制按鈕
     */
    function createControlButtons() {
        // 先移除除了延遲顯示以外的所有舊按鈕
        const existingButtons = controls.querySelectorAll('.control-item');
        existingButtons.forEach(btn => btn.remove());

        Object.keys(ALL_STREAMS).forEach(key => {
            const button = document.createElement('div');
            button.className = 'control-item';
            button.textContent = ALL_STREAMS[key].label || key;
            button.dataset.key = key;
            button.addEventListener('click', () => swapCam(key));
            controls.appendChild(button);
        });
        updateControlSelection();
    }
    
    /**
     * 更新控制按鈕的選中狀態
     */
    function updateControlSelection() {
        const buttons = controls.querySelectorAll('.control-item');
        buttons.forEach(button => {
            const key = button.dataset.key;
            if (currentKeys[currentIndex] === key) {
                button.classList.add('selected');
            } else {
                button.classList.remove('selected');
            }
        });
    }

    /**
     * 載入 YouTube API Iframe Player API
     */
    function loadYoutubeApi() {
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
    
    // 全局函數：YouTube API 準備就緒時呼叫
    window.onYouTubeIframeAPIReady = function() {
        isApiReady = true;
        for (let i = 0; i < NUM_CAMS; i++) {
            initPlayer(i);
        }
        createControlButtons(); // API ready 後再建立按鈕
    }

    /**
     * 初始化單一播放器
     */
    function initPlayer(index) {
        const camKey = currentKeys[index];
        const streamData = ALL_STREAMS[camKey];
        if (!streamData) return;

        const player = new YT.Player(`player-${index}`, {
            videoId: streamData.id,
            playerVars: {
                'controls': 0, // 隱藏控制列
                'disablekb': 1, // 禁用鍵盤控制
                'modestbranding': 1, // 隱藏 YouTube logo
                'showinfo': 0, // 隱藏影片資訊
                'rel': 0, // 禁用相關影片
                'autoplay': 1, // 允許自動播放 (解決 Chrome 上的 153 錯誤)
                'mute': (index !== currentIndex) ? 1 : 0, // 只有選中的畫面才不靜音
                'loop': 1, // 循環播放
                'iv_load_policy': 3, // 禁用註解
                'playsinline': 1, // 啟用內嵌播放
                'start': 1 // 從 1 秒開始 (有助於繞過一些載入問題)
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
        players[index] = player;
        updateLabel(index, streamData.label);
    }

    /**
     * 更新畫面標籤
     */
    function updateLabel(index, label) {
        document.getElementById(`label-${index}`).textContent = label;
    }

    /**
     * 播放器準備就緒
     */
    function onPlayerReady(event) {
        // 確保影片播放，且因為 loop=1, 需手動設定 playlist
        event.target.playVideo();
        event.target.setLoop(true);
        
        // 確保選中畫面取消靜音，未選中畫面靜音
        const index = parseInt(event.target.a.id.split('-')[1]);
        if (index === currentIndex) {
             event.target.unMute();
        } else {
            event.target.mute();
        }
    }

    /**
     * 播放狀態改變
     */
    function onPlayerStateChange(event) {
        const player = event.target;
        const state = event.data;
        if (state === YT.PlayerState.ENDED) { 
            refreshPlayer(player); 
        } 
        // 確保影片在暫停或緩衝時能自動恢復播放 (達成背景播放效果)
        else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.BUFFERING) {
            player.playVideo();
        }
    }
    
    /**
     * 播放器錯誤處理
     */
    function onPlayerError(event) {
        // 錯誤代碼 150/101 表示影片無法播放 (例如：版權或隱私限制)
        // 這裡我們只刷新
        console.error(`Player Error on Index ${event.target.a.id.split('-')[1]}: Code ${event.data}`);
        refreshPlayer(event.target);
    }
    
    /**
     * 刷新播放器 (用於錯誤或結束時重新載入)
     */
    function refreshPlayer(player) {
        const index = parseInt(player.a.id.split('-')[1]);
        const camKey = currentKeys[index];
        const streamData = ALL_STREAMS[camKey];
        if (streamData) {
            player.loadVideoById({
                videoId: streamData.id,
                startSeconds: 1 // 重新載入時從 1 秒開始
            });
        }
    }

    /**
     * 檢查延遲是否過高並刷新
     */
    function _refreshPlayerIfHighLatency(player) {
        if (player && typeof player.getVideoLoadedFraction === 'function') {
            try {
                // 檢查延遲 (getMediaTime - getCurrentTime)
                const mediaTime = player.getMediaTime();
                const currentTime = player.getCurrentTime();
                const latency = mediaTime - currentTime;
                
                // 如果延遲超過 15 秒，視為嚴重延遲，自動刷新
                if (latency > 15) {
                    refreshPlayer(player);
                }
            } catch (e) {
                // 忽略錯誤
            }
        }
    }

    /**
     * 選中某個畫面 (切換聲音)
     */
    function selectCam(index) {
        // 1. 更新選中狀態
        document.getElementById(`container-${currentIndex}`).classList.remove('selected');
        currentIndex = index;
        document.getElementById(`container-${currentIndex}`).classList.add('selected');

        // 2. 切換靜音/非靜音
        players.forEach((player, i) => {
            if (player && typeof player.isMuted === 'function') {
                if (i === currentIndex) {
                    player.unMute();
                    player.setVolume(100);
                } else {
                    player.mute();
                }
            }
        });

        // 3. 更新控制按鈕的選中狀態
        updateControlSelection();
        
        // 4. 初始化時，更新選中畫面的延遲顯示
        updateLatencyDisplay(players[currentIndex]);
    }

    /**
     * 切換當前選中的畫面為新的直播源
     */
    function swapCam(newKey) {
        const oldKey = currentKeys[currentIndex];
        
        // 檢查是否已經在播放這個影片
        if (oldKey === newKey) return; 

        // 1. 更新內部狀態
        currentKeys[currentIndex] = newKey;
        const newStreamData = ALL_STREAMS[newKey];
        
        // 2. 載入新的影片
        const player = players[currentIndex];
        player.loadVideoById({
            videoId: newStreamData.id,
            startSeconds: 1,
        });

        // 3. 更新標籤和控制按鈕狀態
        updateLabel(currentIndex, newStreamData.label);
        updateControlSelection();
    }
    
    /**
     * 更新延遲顯示
     */
    function updateLatencyDisplay(player) {
        try {
            const mediaTime = player.getMediaTime();
            const currentTime = player.getCurrentTime();
            const latency = Math.round(mediaTime - currentTime);
            
            if (!isNaN(latency) && isFinite(latency) && latency >= 0) {
                latencyDisplay.innerText = `延遲：約 ${latency} 秒`;
                
                // 根據延遲值顯示不同顏色
                if (latency > 10) {
                    latencyDisplay.style.color = '#f00'; // 紅色 (高於閾值)
                } else if (latency > 5) {
                    latencyDisplay.style.color = '#ff0'; // 黃色 (中等延遲)
                } else {
                    latencyDisplay.style.color = '#0f0'; // 綠色 (低延遲)
                }
            } else {
                latencyDisplay.innerText = '延遲：即時/誤差';
                latencyDisplay.style.color = '#fff';
            }
        } catch (e) {
            latencyDisplay.innerText = '延遲：無法讀取';
            latencyDisplay.style.color = '#fff';
        }
    }
    
    /**
     * 全局監控函數：檢查並刷新所有播放器，並更新選中畫面的延遲顯示
     */
    function globalMonitor() {
        if (!isApiReady) return;

        // 1. 檢查並刷新所有四個播放器 (自動化部分)
        players.forEach(_refreshPlayerIfHighLatency);

        // 2. 更新當前選中畫面的延遲顯示 (介面顯示部分)
        updateLatencyDisplay(players[currentIndex]);
    }

    // 每 5 秒執行全局監控
    setInterval(globalMonitor, 5000); 


    // 初始化：載入 API 和建立容器
    createInitialContainers();
    loadYoutubeApi();
    
    // 初始化時，第一次選中左上角 (index 0)
    selectCam(0); 

</script>
</body>
</html>
