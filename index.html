<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>å››åˆ†å‰²ç›£çœ‹ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;padding:0;background:#000;color:#fff;font-family:system-ui, sans-serif;}
    .controls{
      position:fixed; bottom:0; left:0; width:100%; height:78px;
      background:rgba(12,12,12,0.95); display:flex; align-items:center; gap:8px;
      padding:8px 12px; box-sizing:border-box; z-index:3000;
    }
    .controls button{background:#222;color:#fff;border:1px solid #444;padding:8px 12px;border-radius:6px;cursor:pointer;height:40px;}
    .controls button.active{background:#0078d7;border-color:#0078d7;}
    .divider{width:1px;height:60%;background:#333;}
    #regionButtons{display:flex;flex-grow:1;gap:6px;overflow-x:auto;align-items:center;height:100%;}
    .city-btn{background:#111;color:#fff;border:1px solid #555;padding:6px 10px;border-radius:6px;cursor:pointer;height:36px;margin:0 4px;}
    .stage-wrap{position:fixed;top:0;left:0;width:100vw;height:calc(100vh - 78px);display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;z-index:1;}
    .cell{position:relative;overflow:hidden;background:#000;}
    .player-container,.player-container iframe{position:absolute;inset:0;width:100%;height:100%;border:0;display:block;background:black;object-fit:cover;object-position:center;transform:none;}
    .label{position:absolute;left:8px;right:8px;bottom:8px;padding:6px 8px;background:rgba(0,0,0,0.6);border-radius:6px;font-size:14px;color:#fff;pointer-events:none;}
    .fullscreen-active .controls{display:none;}
    .fullscreen-active .stage-wrap{height:100vh;}
    /* è‡¨æ™‚ debug æ¨£å¼ï¼ˆå¯ç§»é™¤ï¼‰ */
    .player-placeholder{color:#fff;padding:10px;background:#111;border:1px solid #444;}
  </style>
</head>
<body>
  <div class="controls" id="controls">
    <button id="select-cam-0" class="active" onclick="selectCam(0)">å·¦ä¸Š</button>
    <button id="select-cam-1" onclick="selectCam(1)">å³ä¸Š</button>
    <button id="select-cam-2" onclick="selectCam(2)">å·¦ä¸‹</button>
    <button id="select-cam-3" onclick="selectCam(3)">å³ä¸‹</button>

    <div class="divider"></div>
    <div id="regionButtons" aria-label="ç¸£å¸‚èˆ‡æ™¯é»é¸å–®" role="toolbar"></div>

    <div class="divider"></div>
    <button id="fullscreenBtn" onclick="toggleFullscreen()">å…¨è¢å¹•</button>

    <div class="divider"></div>
    <!-- å–®ä¸€éœéŸ³æŒ‰éˆ•ï¼Œæ“ä½œç›®å‰é¸å–æ ¼ -->
    <button id="muteBtn" onclick="toggleMuteSelected()">ğŸ”‡ éœéŸ³ï¼ˆé¸å–æ ¼ï¼‰</button>
  </div>

  <div class="stage-wrap" id="stageWrap">
    <div class="cell" data-index="0">
      <div id="player0" class="player-container"></div>
      <div class="label" id="label0">è¼‰å…¥ä¸­...<span class="source-on-screen"></span></div>
    </div>
    <div class="cell" data-index="1">
      <div id="player1" class="player-container"></div>
      <div class="label" id="label1">è¼‰å…¥ä¸­...<span class="source-on-screen"></span></div>
    </div>
    <div class="cell" data-index="2">
      <div id="player2" class="player-container"></div>
      <div class="label" id="label2">è¼‰å…¥ä¸­...<span class="source-on-screen"></span></div>
    </div>
    <div class="cell" data-index="3">
      <div id="player3" class="player-container"></div>
      <div class="label" id="label3">è¼‰å…¥ä¸­...<span class="source-on-screen"></span></div>
    </div>
  </div>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // --------- è³‡æ–™ï¼ˆç¤ºç¯„å°‘é‡ï¼Œè«‹æŠŠä½ çš„å®Œæ•´ ALL_STREAMS è²¼å›ä¾†ï¼‰ ----------
    const ALL_STREAMS = {
      "å°åŒ—-è²“ç©ºæŒ‡å—å®®": {"id":"215ahZ_0rTg","label":"è²“ç©ºæŒ‡å—å®®","source":"Taipei Travel Live Cam"},
      "æ¡ƒåœ’-åœ‹éš›æ©Ÿå ´": {"id":"91PfFoqvuUk","label":"æ¡ƒåœ’æ©Ÿå ´","source":"Taoyuan Travel"},
      "å°ä¸­-é«˜ç¾æ¿•åœ°": {"id":"fjhg3gAnMFg","label":"å°ä¸­é«˜ç¾","source":"Taichung Travel"},
      "é«˜é›„-å£½å±±è§€æ™¯å°": {"id":"C03Itx8iSC0","label":"å£½å±±è§€æ™¯","source":"Kaohsiung Travel"}
    };

    const PLAYER_IDS = ['player0','player1','player2','player3'];
    const DEFAULT_KEYS = ["å°åŒ—-è²“ç©ºæŒ‡å—å®®","æ¡ƒåœ’-åœ‹éš›æ©Ÿå ´","å°ä¸­-é«˜ç¾æ¿•åœ°","é«˜é›„-å£½å±±è§€æ™¯å°"];

    let players = [null,null,null,null];
    let streamState = [null,null,null,null];
    let selectedCamIndex = 0;
    let perMute = [true,true,true,true]; // æ¯æ ¼éœéŸ³ç‹€æ…‹ï¼Œé è¨­éœéŸ³

    // å®‰å…¨å»ºç«‹ player çš„ wrapperï¼ˆæœ‰éŒ¯èª¤æœƒå›å¡«æç¤ºï¼‰
    function safeCreatePlayer(elId, videoId, onReady, onStateChange) {
      try {
        return new YT.Player(elId, {
          videoId: videoId || '',
          playerVars: {
            autoplay: 1,
            controls: 0,
            modestbranding: 1,
            rel: 0,
            loop: 1,
            playlist: videoId || '',
            mute: 1,
            playsinline: 1
          },
          events: { onReady, onStateChange }
        });
      } catch (e) {
        console.error('safeCreatePlayer error', elId, e);
        const el = document.getElementById(elId);
        if (el) el.innerHTML = '<div class="player-placeholder">æ’­æ”¾å™¨å»ºç«‹å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ Console</div>';
        return null;
      }
    }

    // æª¢æŸ¥ YT æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨æœƒåœ¨ API è¼‰å…¥å¾Œå‘¼å« onYouTubeIframeAPIReady
    window.onYouTubeIframeAPIReady = function() {
      // å»ºç«‹å››å€‹ player
      PLAYER_IDS.forEach((id, idx) => {
        const key = DEFAULT_KEYS[idx];
        const vid = (ALL_STREAMS[key] && ALL_STREAMS[key].id) ? ALL_STREAMS[key].id : '';
        if (ALL_STREAMS[key]) streamState[idx] = { key, ...ALL_STREAMS[key] };
        players[idx] = safeCreatePlayer(id, vid, onPlayerReady, onPlayerStateChange);
        updateLabel(idx);
      });
    };

    function grantIframeAllow(player){
      try{
        const iframe = player.getIframe();
        iframe.setAttribute('allow','autoplay; fullscreen; picture-in-picture');
      }catch(e){}
    }

    function onPlayerReady(event) {
      grantIframeAllow(event.target);
      const idx = players.indexOf(event.target);
      if (idx >= 0) {
        if (perMute[idx]) event.target.mute();
        else event.target.unMute();
      } else {
        try{ event.target.mute(); }catch(e){}
      }
      try{ event.target.playVideo(); }catch(e){}
    }

    function onPlayerStateChange(event) {
      const st = event.data;
      const idx = players.indexOf(event.target);

      // è‹¥å½±ç‰‡çµæŸæˆ–è¢« cueï¼Œä½¿ç”¨ playlist reloadï¼ˆåŒ IDï¼‰ä»¥é¿å…æ¨è–¦æˆ–åœä½
      if ((st === YT.PlayerState.ENDED || st === YT.PlayerState.CUED) && idx >= 0 && streamState[idx]) {
        try {
          event.target.loadPlaylist({ list: [streamState[idx].id], index: 0 });
          event.target.playVideo();
        } catch(e){}
      }

      // è‹¥ UNSTARTEDï¼Œå˜—è©¦é‡æ–° load
      if (st === YT.PlayerState.UNSTARTED && idx >= 0 && streamState[idx]) {
        try { event.target.loadVideoById(streamState[idx].id, 0); event.target.playVideo(); } catch(e){}
      }
    }

    function updateLabel(idx) {
      const s = streamState[idx];
      const el = document.getElementById('label' + idx);
      if (!el) return;
      if (s) el.innerHTML = `${s.label}<span class="source-on-screen">ä¾†æº: ${s.source}</span>`;
      else el.innerHTML = `è¼‰å…¥ä¸­...<span class="source-on-screen"></span>`;
    }

    // é¸å–æ ¼å­ï¼ˆå·¦å´æŒ‰éˆ•ï¼‰
    function selectCam(i) {
      selectedCamIndex = i;
      for (let k=0;k<4;k++){
        const btn = document.getElementById('select-cam-' + k);
        if (btn) btn.classList.toggle('active', k === i);
      }
      refreshMuteBtnLabel();
    }

    // å–®ä¸€éœéŸ³æŒ‰éˆ•ï¼ˆä½œç”¨æ–¼ç›®å‰é¸å–æ ¼ï¼‰
    function toggleMuteSelected() {
      const idx = selectedCamIndex;
      const p = players[idx];
      if (!p) return;
      perMute[idx] = !perMute[idx];
      try {
        if (perMute[idx]) p.mute();
        else p.unMute();
      } catch(e){}
      refreshMuteBtnLabel();
    }

    function refreshMuteBtnLabel(){
      const btn = document.getElementById('muteBtn');
      if (!btn) return;
      const idx = selectedCamIndex;
      btn.innerText = perMute[idx] ? `ğŸ”‡ éœéŸ³ï¼ˆ${idx===0?'å·¦ä¸Š':idx===1?'å³ä¸Š':idx===2?'å·¦ä¸‹':'å³ä¸‹'}ï¼‰` : `ğŸ”Š è§£é™¤ï¼ˆ${idx===0?'å·¦ä¸Š':idx===1?'å³ä¸Š':idx===2?'å·¦ä¸‹':'å³ä¸‹'}ï¼‰`;
    }

    // å°‡æŒ‡å®š stream è¨­å®šåˆ°ç›®å‰é¸å–æ ¼
    function setStream(streamKey) {
      const s = ALL_STREAMS[streamKey];
      if (!s) return;
      const idx = selectedCamIndex;
      const p = players[idx];
      streamState[idx] = { key: streamKey, ...s };
      if (!p) { updateLabel(idx); return; }

      // å„ªå…ˆç”¨ playlist åŒ id çš„æ–¹å¼è¼‰å…¥ä»¥é¿å…æ¨è–¦ç•«é¢
      try {
        p.loadPlaylist({ list: [s.id], index: 0 });
        p.playVideo();
      } catch(e) {
        try { p.loadVideoById(s.id); p.playVideo(); } catch(e){}
      }

      // å¥—ç”¨è©²æ ¼éœéŸ³ç‹€æ…‹
      try {
        if (perMute[idx]) p.mute(); else p.unMute();
      } catch(e){}
      updateLabel(idx);
    }

    // region buttons: ä»¥ ALL_STREAMS åˆ—å‡ºï¼ˆå¯æ”¹ç‚ºåˆ†å€ï¼‰
    function renderRegionButtons() {
      const c = document.getElementById('regionButtons');
      c.innerHTML = '';
      Object.keys(ALL_STREAMS).forEach(key => {
        const s = ALL_STREAMS[key];
        const b = document.createElement('button');
        b.className = 'city-btn';
        b.innerText = s.label || key;
        b.onclick = () => setStream(key);
        c.appendChild(b);
      });
    }

    // å…¨è¢å¹•åˆ‡æ›
    function toggleFullscreen() {
      const wrap = document.getElementById('stageWrap');
      if (!document.fullscreenElement) {
        wrap.requestFullscreen().catch(()=>{});
      } else {
        document.exitFullscreen().catch(()=>{});
      }
    }
    function applyFullscreenClass(){ document.body.classList.toggle('fullscreen-active', !!document.fullscreenElement); }
    document.addEventListener('fullscreenchange', applyFullscreenClass);
    document.addEventListener('webkitfullscreenchange', applyFullscreenClass);
    document.addEventListener('mozfullscreenchange', applyFullscreenClass);
    document.addEventListener('MSFullscreenChange', applyFullscreenClass);

    // ç•¶é é¢å›åˆ°å¯è¦‹æ™‚å˜—è©¦æ¢å¾©æ’­æ”¾
    function forceResumeAll(){
      players.forEach((p, i) => {
        if (!p) return;
        try {
          const st = p.getPlayerState();
          if (st !== YT.PlayerState.PLAYING && st !== YT.PlayerState.BUFFERING) {
            p.playVideo();
            setTimeout(()=>{
              try {
                const st2 = p.getPlayerState();
                if (st2 !== YT.PlayerState.PLAYING && streamState[i]) {
                  p.loadPlaylist({ list: [streamState[i].id], index: 0 });
                  p.playVideo();
                }
              } catch(e){}
            }, 700);
          }
        } catch(e){}
      });
    }
    document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState === 'visible') forceResumeAll(); });

    // åˆå§‹
    document.addEventListener('DOMContentLoaded', ()=>{
      renderRegionButtons();
      refreshMuteBtnLabel();
      // æª¢æŸ¥ YT API æ˜¯å¦å·²è¼‰å…¥ï¼ˆè‹¥å°šæœªè¼‰å…¥ï¼ŒonYouTubeIframeAPIReady æœƒè¢«å‘¼å«ï¼‰
      if (typeof YT === 'undefined') {
        console.log('YouTube iframe API å°šæœªè¼‰å…¥ï¼Œç­‰å¾… onYouTubeIframeAPIReady()');
      } else if (typeof YT.Player === 'function' && window.onYouTubeIframeAPIReady === undefined) {
        // è‹¥ API å·²å­˜åœ¨ä½† callback å°šæœªè¨­å®šï¼ˆé€šå¸¸ä¸æœƒï¼‰ï¼Œå¯æ‰‹å‹•å‘¼å«
        try { window.onYouTubeIframeAPIReady(); } catch(e){ console.warn(e); }
      }
    });
  </script>
</body>
</html>
